{% extends 'base.html' %}
{% block content %}
{% for todo in todos %}
  {% now "Y-m-d" as todays_date %}
  {% if todays_date >= todo.expiration_date|date:"Y-m-d" and todo.status != 'Expired' %}
    <script>
      window.location.href = "change-status/{{todo.id}}/Expired";
    </script>
  {% endif %}
{% endfor %}
  <div class="container pt-4">
      <div class="row p-0 mt-4" >
        <div class="col-lg-4 mx-auto shadow p-0">
          <div class="alert alert-info">
               <h2>Add new task</h2>
          </div>
          <div class="p-4">
            <form action="/add-todo/" method="POST">
              {% csrf_token %}
              {{form.as_p}}
              <hr>
              <input type="submit" value="Add" class="btn btn-info">
            </form>
          </div>
        </div>

        <div class="col">
          <div class="border">

            {% if todos|length == 0%}
              <div class="p-4">
                <br>
                <br>
                <div class="alert alert-info text-center">
                  <p class="" style="font-size: 30px;">No tasks</p>
                </div>
                <br>
                <br>
              </div>

            {% else %}
            <div>
              <table class="table table-bordered">
                <thead class="thead-light">
                  <tr>
                    <th>#</th>
                    <th>Title</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>User</th>
                    <th>Creation date</th>
                    <th>Expiration date</th>
                    <th>Action</th>
                  </tr>
                </thead>

                <tbody>
                    {% for todo in todos %}
                    <tr>
                      <td>{{forloop.counter}}</td>
                      <td>{{todo.title}}</td>
                      <td>{{todo.status}}</td>
                      <td>{{todo.priority}}</td>
                      <td>{{todo.user}}</td>
                      <td>{{todo.creation_date}}</td>
                      <td>{{todo.expiration_date}}</td>
                      <td>
                        <a href="delete-todo/{{todo.id}}" title="Delete">üóëÔ∏è</a>
                        <a href="todo/{{todo.id}}/comments" title="Comments">üó®</a>
                        {% if todo.status == 'In progress' %}
                          <a href="change-status/{{todo.id}}/Done" title="Mark complete">‚úÖ</a>
                        {% elif todo.status == 'To do' %}
                          <a href="change-status/{{todo.id}}/In progress" title="Mark in progress">üïí</a>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                </tbody>

              </table>
            </div>
            {% endif %}
          </div>
        </div>
        {% if todos|length > 0 %}
        <div class="container pt-4"> 
          <div id="chartContainer" style="height: 200px; width: 100%"></div>
          <script>
            window.onload = function () {
              CanvasJS.addColorSet("custom", ["#FF0000", "#008000", "#FFA500", "#ADD8E6"]);
              var chart = new CanvasJS.Chart("chartContainer", {
                animationEnabled: true,
                colorSet: "custom",
                theme: "light2",
                title: {
                  text: "Your statistics"
                },
                axisX: {
                  interval: 1
                },
                axisY: {
                  includeZero: true,
                  interval: 1
                },
                data: [{
                  type: "bar",
                  name: "tasks",
                  dataPoints: [
                      {label: "Expired", y: {{stats.Expired}} },
                      {label: "Done", y: {{stats.Done}} },
                      {label: "In progress", y: {{stats.In_progress}} },
                      {label: "To do", y: {{stats.To_do}} },
                  ]
                }]
              });
              chart.render();
            }
          </script>
          <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
        </div>
        {% endif %}
      </div>
  </div>
{% endblock %}